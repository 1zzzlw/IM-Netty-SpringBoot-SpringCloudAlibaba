<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.zzzlew.zzzimserver.mapper.ConversationMapper">

    <select id="selectList"
            resultType="com.zzzlew.zzzimserver.pojo.entity.Conversation">
        select *
        from conversation c
        <where>
            -- 必要查条件
            c.user_id = #{userId}
            and c.status = 1
            <if test="quitTime != null and quitTime != ''">
                -- 如果用户退出时间非空
                and c.update_time >= #{quitTime}
            </if>
        </where>
    </select>

    <update id="updateConversationStatus">
        update conversation
        set latest_msg      = #{content},
            latest_msg_time = #{sendTime},
            status          = 1,
            unread_count    = CASE
                                  WHEN user_id = #{receiverId}
                                      THEN unread_count + 1
                                  ELSE unread_count
                END
        where id = #{conversationId}
    </update>

    <insert id="insertGroupConversation"
            parameterType="com.zzzlew.zzzimserver.pojo.dto.conversation.GroupConversationDTO">
        insert into group_conversation (id, group_name, group_avatar, owner_id)
        values (#{id}, #{groupName}, #{groupAvatar}, #{ownerId})
    </insert>

    <update id="updateGroupMemberCount">
        update group_conversation
        set member_count = member_count + 1
        where id = #{conversationId}
    </update>

    <select id="selectGroupMemberListByConversationId"
            resultType="com.zzzlew.zzzimserver.pojo.vo.user.GroupMemberVO"
            parameterType="java.lang.String">
        select gm.user_id, gm.role, ua.username, ua.avatar
        from group_member gm
                 join user_auth ua on gm.user_id =
                                      ua.user_id
        where gm.group_id = #{conversationId}
    </select>

    <insert id="insertConversation">
        insert into conversation (id, user_id, target_id, type)
        values (#{conversationId}, #{toUserId}, #{fromUserId}, #{type})
    </insert>


</mapper>